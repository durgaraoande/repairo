<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" data-page="customers">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Customers - Repairo Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/app.css" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body data-page="customers">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="/admin/dashboard">
        <i class="fas fa-mobile-alt"></i><span>Repairo</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <a class="nav-link d-flex align-items-center gap-2" href="/logout">
          <i class="fas fa-sign-out-alt"></i><span>Logout</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="nav-tabs-container">
    <div class="container-fluid px-4">
      <ul class="nav nav-tabs flex-nowrap">
        <li class="nav-item"><a class="nav-link" href="/admin/dashboard"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="/admin/customers"><i class="fas fa-users me-2"></i>Customers</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/messages"><i class="fas fa-comments me-2"></i>Messages</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/repairs"><i class="fas fa-tools me-2"></i>Repairs</a></li>
      </ul>
    </div>
  </div>

  <main class="container-fluid px-4 pb-5">
    <header class="page-header">
      <h1 class="page-title">Customer Management</h1>
      <p class="page-subtitle">Manage customers, statuses, and communication.</p>
    </header>

    <section class="card mb-4">
      <div class="card-body">
        <form method="get" class="row g-3 align-items-center search-form">
          <div class="col-md-10 col-sm-8">
            <input type="search" name="search" placeholder="Search customers by name..."
                   th:value="${search}" aria-label="Search customers"/>
          </div>
          <div class="col-md-2 col-sm-4">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-search me-2"></i>Search
            </button>
          </div>
        </form>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-users"></i>All Customers</h3>
      </div>
      <div class="table-responsive">
        <table class="table responsive-stack mb-0">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Device</th>
              <th>Issue</th>
              <th>Status</th>
              <th>Onboarding</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customersTableBody">
            <tr th:if="${#lists.isEmpty(customers)}">
              <td colspan="6">
                <div class="empty-state">
                  <i class="fas fa-users mb-3" style="font-size:3rem;"></i>
                  <h5>No Customers</h5>
                  <p>Will appear as conversations start.</p>
                </div>
              </td>
            </tr>
            <tr th:each="customer : ${customers}" data-customer-row>
              <td data-label="Customer">
                <div class="d-flex align-items-center gap-3">
                  <div class="avatar-circle">
                    <span th:text="${customer.name != null ? customer.name.substring(0,1).toUpperCase() : 'U'}">U</span>
                  </div>
                  <div>
                    <div data-col="name" class="fw-semibold text-truncate" style="max-width:160px;"
                         th:text="${customer.name ?: 'Unknown'}">Unknown</div>
                    <small class="text-secondary d-block text-truncate" style="max-width:160px;"
                           th:text="${customer.phone ?: 'No phone'}">No phone</small>
                  </div>
                </div>
              </td>
              <td data-label="Device">
                <span class="text-secondary" th:text="${customer.phoneModel ?: 'Unknown Model'}">Unknown Model</span>
              </td>
              <td data-label="Issue">
                <span class="d-inline-block text-truncate" style="max-width:220px;"
                      th:text="${customer.issue ?: 'No issue specified'}"
                      th:title="${customer.issue}">No issue specified</span>
              </td>
              <td data-label="Status">
                <select class="form-select form-select-sm customer-status-select"
                        th:data-customer-id="${customer.customerId}">
                  <option th:value="PENDING"
                          th:selected="${customer.repairStatus == T(com.repairo.model.RepairStatus).PENDING}">
                    Pending
                  </option>
                  <option th:value="IN_PROGRESS"
                          th:selected="${customer.repairStatus == T(com.repairo.model.RepairStatus).IN_PROGRESS}">
                    In Progress
                  </option>
                  <option th:value="COMPLETED"
                          th:selected="${customer.repairStatus == T(com.repairo.model.RepairStatus).COMPLETED}">
                    Completed
                  </option>
                </select>
              </td>
              <td data-label="Onboarding">
                <span th:switch="${customer.onboardingState}" class="status-badge">
                  <span th:case="'NEW'" class="status-pending">New</span>
                  <span th:case="'AWAITING_NAME'" class="status-in-progress">Await Name</span>
                  <span th:case="'AWAITING_ISSUE'" class="status-in-progress">Await Issue</span>
                  <span th:case="'AWAITING_PHONE_MODEL'" class="status-in-progress">Await Model</span>
                  <span th:case="'COMPLETED'" class="status-completed">Completed</span>
                  <span th:case="*" class="status-pending">Unknown</span>
                </span>
              </td>
              <td data-label="Actions">
                <button class="btn btn-sm btn-outline-primary"
                        th:data-customer-id="${customer.customerId}"
                        onclick="showMessageModal(this)"
                        type="button">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="customersPaginationContainer"></div>
    </section>
  </main>

  <!-- Message Modal -->
  <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-paper-plane me-2"></i>Send Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Dismiss"></button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" id="messageText" rows="4" placeholder="Type message..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="sendMessage()">
            <i class="fas fa-paper-plane me-2"></i>Send Message
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>